<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no" />
    <title>Hey Boo - Chats</title>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
          -webkit-font-smoothing: antialiased;
          background: #f0f4f8;
          height: 100vh;
          overflow: hidden;
        }

        /* Base container for chat view */
        .chat-view-content {
          display: flex;
          flex-direction: column;
          height: 100vh;
          background-color: #f0f4f8;
        }

        /* Chat message area */
        .chat-window {
          flex-grow: 1;
          padding: 1rem 1.5rem;
          overflow-y: auto;
          display: flex;
          flex-direction: column;
          gap: 0.5rem;
        }

        /* Date Divider */
        .date-divider {
          text-align: center;
          margin: 1.5rem 0 1rem 0;
          position: relative;
          color: #8899a6;
          font-size: 0.8rem;
          font-weight: 500;
        }

        .date-divider span {
          background-color: #e1e8ed;
          padding: 0.25rem 0.75rem;
          border-radius: 12px;
          position: relative;
          z-index: 1;
        }

        .date-divider::before,
        .date-divider::after {
          content: '';
          position: absolute;
          top: 50%;
          width: calc(50% - 60px);
          height: 1px;
          background-color: #e1e8ed;
        }

        .date-divider::before { left: 0; }
        .date-divider::after  { right: 0; }

        /* Message Container */
        .message-container {
          display: flex;
          max-width: 75%;
          align-self: flex-start;
          margin-bottom: 0.25rem;
        }

        .message-container.own-message {
          align-self: flex-end;
        }

        /* Message Bubble */
        .message-bubble {
          padding: 0.65rem 1rem;
          border-radius: 18px;
          background-color: #ffffff;
          color: #14171a;
          box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
          line-height: 1.45;
          word-wrap: break-word;
          display: flex;
          flex-direction: column;
          max-width: 100%;
        }

        .message-container.own-message .message-bubble {
          background: linear-gradient(135deg, #8c68db, #a66fd5);
          color: #ffffff;
        }

        .message-text {
          font-size: 0.95rem;
          margin-bottom: 0.25rem;
        }

        .message-time {
          font-size: 0.7rem;
          color: #aab8c2;
          align-self: flex-end;
          margin-top: 0.1rem;
        }

        .message-container.own-message .message-time {
          color: rgba(255, 255, 255, 0.7);
        }

        /* Input Area */
        .chat-input-area {
          padding: 0.75rem 1.5rem;
          background-color: #ffffff;
          border-top: 1px solid #e6ecf0;
          flex-shrink: 0;
          position: relative;
        }

        .chat-input {
          display: flex;
          align-items: flex-end;
          gap: 0.75rem;
          background-color: #f5f8fa;
          border-radius: 22px;
          padding: 0.5rem 0.5rem 0.5rem 0.75rem;
          border: 1px solid #e6ecf0;
        }

        .chat-input textarea {
          flex-grow: 1;
          border: none;
          outline: none;
          background: transparent;
          font-size: 0.95rem;
          resize: none;
          overflow-y: auto;
          padding: 0.4rem 0.25rem;
          line-height: 1.4;
          max-height: 100px;
          font-family: inherit;
        }

        .chat-input textarea::placeholder {
          color: #aab8c2;
        }

        /* Input action buttons */
        .input-action-button {
          background: transparent;
          border: none;
          color: #657786;
          cursor: pointer;
          padding: 0.5rem;
          border-radius: 50%;
          width: 36px;
          height: 36px;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: color 0.2s ease, background-color 0.2s ease;
          font-size: 1.1rem;
          flex-shrink: 0;
        }

        .input-action-button:hover {
          color: #8c68db;
          background-color: #e8e4f5;
        }

        .input-action-button.active {
          color: #8c68db;
          background-color: #e8e4f5;
        }

        .send-button {
          color: #ff80b0;
        }

        .send-button:hover {
          color: #fff;
          background-color: #ff80b0;
        }

        .send-button:disabled {
          color: #bdc5cd !important;
          background-color: transparent !important;
          cursor: not-allowed;
        }

        /* Emoji Picker Popover */
        .emoji-picker-popover {
          position: absolute;
          bottom: calc(100% + 10px);
          left: 1.5rem;
          background-color: #fff;
          border-radius: 10px;
          box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
          padding: 0.75rem;
          width: 280px;
          z-index: 100;
          border: 1px solid #eee;
          display: none;
          animation: fadeIn 0.2s ease;
        }

        .emoji-picker-popover.active {
          display: block;
        }

        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(5px); }
          to   { opacity: 1; transform: translateY(0); }
        }

        .emoji-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(38px, 1fr));
          gap: 5px;
          max-height: 200px;
          overflow-y: auto;
        }

        .emoji-button {
          background: none;
          border: none;
          padding: 0;
          width: 38px;
          height: 38px;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          font-size: 1.4rem;
          transition: background-color 0.15s ease;
          border-radius: 6px;
        }

        .emoji-button:hover {
          background-color: #f0f4f8;
        }

        /* Responsive */
        @media (max-width: 768px) {
          .chat-window {
            padding: 0.75rem 1rem;
          }

          .chat-input-area {
            padding: 0.5rem 1rem;
          }

          .message-container {
            max-width: 85%;
          }
        }
    </style>
</head>
<body>
<div class="chat-view-content">
    <!-- Chat Window -->
    <div class="chat-window" id="chatWindow">
        <!-- Messages will be rendered here -->
    </div>

    <!-- Input Area -->
    <div class="chat-input-area">
        <!-- Emoji Picker -->
        <div id="emojiPicker" class="emoji-picker-popover">
            <div class="emoji-grid" id="emojiGrid"></div>
        </div>

        <div class="chat-input">
            <button class="input-action-button emoji-toggle-button" onclick="toggleEmojiPicker()" title="Add emoji">
                <i class="far fa-smile"></i>
            </button>

            <textarea
                    id="messageInput"
                    placeholder="Type a message..."
                    rows="1"
                    oninput="handleInput()"
                    onkeydown="handleKeyDown(event)"
            ></textarea>

            <button
                    onclick="sendMessage()"
                    class="input-action-button send-button"
                    id="sendButton"
                    disabled
                    title="Send message"
            >
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<script>
    const API_BASE_URL = "http://10.0.2.2:8080";

    let messages = [];
    let showEmojiPicker = false;
    let pollingIntervalId = null;

    const commonEmojis = ["â¤ï¸", "ðŸ˜Š", "ðŸ˜˜", "ðŸ¥°", "ðŸ˜", "ðŸ¤—", "ðŸ˜‚", "ðŸ¤”", "ðŸ‘", "ðŸŽ‰", "ðŸ•", "âœ¨", "ðŸ‘‹", "ðŸ’•", "ðŸ¥º", "ðŸ™"];

    let currentUser = null;
    let currentUsername = null;

    // ===== Helper: get username from stored user =====
    function getUsernameFromUser(user) {
      if (!user || typeof user !== "object") return null;
      if (user.username) return user.username;
      if (user.email)    return user.email; // fallback
      return null;
    }

    // ===== Init =====
    document.addEventListener('DOMContentLoaded', () => {
      const storedUser = localStorage.getItem("user");
      const token = localStorage.getItem("authToken");

      if (!token || !storedUser) {
        // Not logged in, send back to login
        window.location.href = "mobile_index.html";
        return;
      }

      try {
        currentUser = JSON.parse(storedUser);
        currentUsername = getUsernameFromUser(currentUser);
      } catch (e) {
        console.error("Failed to parse stored user:", e);
        window.location.href = "mobile_index.html";
        return;
      }

      // If not linked, don't allow chat
      if (!currentUser.couple_id) {
        window.location.href = "linkpartner.html";
        return;
      }

      renderEmojis();
      fetchMessages(true);

      // Poll for new messages every 3s
      pollingIntervalId = setInterval(() => {
        fetchMessages(false);
      }, 3000);

      // Close emoji picker on outside click
      document.addEventListener('click', function(e) {
        const picker = document.getElementById('emojiPicker');
        const toggleBtn = document.querySelector('.emoji-toggle-button');

        if (showEmojiPicker &&
            !picker.contains(e.target) &&
            !toggleBtn.contains(e.target)) {
          toggleEmojiPicker();
        }
      });
    });

    // ===== Fetch chat history from backend =====
    async function fetchMessages(initial = false) {
      const token = localStorage.getItem("authToken");
      if (!token) return;

      try {
        const res = await fetch(`${API_BASE_URL}/auth/chat/receive`, {
          method: "GET",
          headers: {
            Authorization: `Bearer ${token}`,
          },
        });

        const data = await res.json();

        if (!res.ok) {
          console.error("Failed to load messages:", data);
          return;
        }

        if (!Array.isArray(data.messages)) {
          console.warn("No messages array in response");
          return;
        }

        messages = data.messages;
        renderMessages();
        if (initial) scrollToBottom(true);
      } catch (err) {
        console.error("Error fetching messages:", err);
      }
    }

    // ===== Send message to backend =====
    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      const button = document.getElementById('sendButton');

      if (!text) return;

      const token = localStorage.getItem("authToken");
      if (!token) {
        alert("You must be logged in to send messages.");
        return;
      }

      button.disabled = true;

      try {
        const res = await fetch(`${API_BASE_URL}/auth/chat/send`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          // If your backend needs receiver info, you can add it here.
          // For a couple chat, backend can infer receiver from couple_id.
          body: JSON.stringify({ content: text }),
        });

        const data = await res.json();

        if (!res.ok) {
          console.error("Failed to send message:", data);
          alert(data.error || "Failed to send message.");
        } else {
          // If backend returns full message, you can push it:
          if (data.message) {
            messages.push(data.message);
            renderMessages();
            scrollToBottom();
          } else {
            // Otherwise re-fetch messages to stay in sync
            await fetchMessages(false);
          }
        }
      } catch (err) {
        console.error("Error sending message:", err);
        alert("Error sending message. Please try again.");
      } finally {
        input.value = "";
        adjustTextareaHeight();
        updateSendButton();
        button.disabled = false;
      }
    }

    // ===== Rendering =====
    function renderEmojis() {
      const grid = document.getElementById('emojiGrid');
      grid.innerHTML = commonEmojis.map(emoji =>
        `<button class="emoji-button" onclick="addEmoji('${emoji}')" title="Add ${emoji}">${emoji}</button>`
      ).join('');
    }

    function renderMessages() {
      const chatWindow = document.getElementById('chatWindow');
      if (!chatWindow) return;

      let html = '';
      let lastDate = null;

      messages.forEach(msg => {
        const ts = getMessageTimestamp(msg);
        const msgDate = formatDate(ts);

        // Date divider per day
        if (msgDate !== lastDate) {
          html += `
            <div class="date-divider">
              <span>${msgDate}</span>
            </div>
          `;
          lastDate = msgDate;
        }

        const sender = (msg.sender || msg.Sender || "").toString();
        const isOwn = currentUsername && sender &&
                      (sender.toLowerCase() === currentUsername.toLowerCase());

        html += `
          <div class="message-container ${isOwn ? "own-message" : ""}">
            <div class="message-bubble">
              <span class="message-text">${escapeHtml(msg.content || msg.Content || "")}</span>
              <span class="message-time">${formatTime(ts)}</span>
            </div>
          </div>
        `;
      });

      chatWindow.innerHTML = html;
    }

    // ===== Timestamp helpers =====
    function getMessageTimestamp(msg) {
      if (!msg) return null;

      // If backend returns unix seconds (int64)
      if (typeof msg.timestamp === "number") {
        return new Date(msg.timestamp * 1000);
      }
      if (typeof msg.Timestamp === "number") {
        return new Date(msg.Timestamp * 1000);
      }

      // Or ISO string
      const raw = msg.timestamp || msg.Timestamp || msg.created_at || msg.createdAt || msg.time;
      if (!raw) return null;
      return new Date(raw);
    }

    function formatTime(timestamp) {
      if (!timestamp) return "";
      const date = new Date(timestamp);
      return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    }

    function formatDate(timestamp) {
      if (!timestamp) return "";
      const date = new Date(timestamp);
      const today = new Date();
      const yesterday = new Date();
      yesterday.setDate(today.getDate() - 1);

      if (date.toDateString() === today.toDateString()) return "Today";
      if (date.toDateString() === yesterday.toDateString()) return "Yesterday";
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    // ===== Input + emoji handlers =====
    function handleInput() {
      adjustTextareaHeight();
      updateSendButton();
    }

    function handleKeyDown(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    function adjustTextareaHeight() {
      const textarea = document.getElementById('messageInput');
      textarea.style.height = 'auto';
      const maxHeight = 100;
      textarea.style.height = `${Math.min(textarea.scrollHeight, maxHeight)}px`;
    }

    function updateSendButton() {
      const input = document.getElementById('messageInput');
      const button = document.getElementById('sendButton');
      button.disabled = !input.value.trim();
    }

    function toggleEmojiPicker() {
      showEmojiPicker = !showEmojiPicker;
      const picker = document.getElementById('emojiPicker');
      const toggleBtn = document.querySelector('.emoji-toggle-button');

      if (showEmojiPicker) {
        picker.classList.add('active');
        toggleBtn.classList.add('active');
      } else {
        picker.classList.remove('active');
        toggleBtn.classList.remove('active');
      }
    }

    function addEmoji(emoji) {
      const input = document.getElementById('messageInput');
      input.value += emoji;
      input.focus();
      adjustTextareaHeight();
      updateSendButton();
    }

    function scrollToBottom(instant = false) {
      const chatWindow = document.getElementById('chatWindow');
      if (!chatWindow) return;
      chatWindow.scrollTo({
        top: chatWindow.scrollHeight,
        behavior: instant ? "instant" : "smooth",
      });
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
</script>
</body>
</html>
